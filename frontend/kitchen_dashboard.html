{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="dashboard-container">
    <div class="main-content full-width">
        <header>
            <h2>üë®üç≥ Kitchen Display System</h2>
            <div class="status-legend">
                <span class="badge badge-ordered">Ordered</span>
                <span class="badge badge-preparing">Preparing</span>
            </div>
            <button class="btn btn-outline" onclick="fetchOrders()"><i class="fas fa-sync"></i> Refresh</button>
        </header>

        <div id="kitchen-orders" class="orders-grid">
            <div class="loading">Loading orders...</div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api/';

    document.addEventListener('DOMContentLoaded', () => {
        fetchOrders();
        setInterval(fetchOrders, 30000); // Auto-refresh every 30s
    });

    async function fetchOrders() {
        const container = document.getElementById('kitchen-orders');
        try {
            // Fetch 'Ordered' and 'Preparing' status orders
            const res = await fetch(`${API_BASE}dining-orders/?status=Ordered,Preparing&t=${new Date().getTime()}`);
            const data = await res.json();
            const orders = data.results ? data.results : data;
            
            container.innerHTML = '';
            if(!orders || orders.length === 0) {
                container.innerHTML = '<p class="empty-state">No pending orders. Kitchen is clear! üéâ</p>';
                return;
            }

            orders.forEach(order => {
                const card = document.createElement('div');
                card.className = `order-ticket ${order.status.toLowerCase()}`;
                
                let actionBtn = '';
                if(order.status === 'Ordered') {
                    actionBtn = `<button class="btn btn-warning btn-sm" onclick="updateStatus(${order.id}, 'Preparing')">Start Preparing</button>`;
                } else if (order.status === 'Preparing') {
                    actionBtn = `<button class="btn btn-success btn-sm" onclick="updateStatus(${order.id}, 'Served')">Mark Served</button>`;
                }

                let itemsHtml = order.items_details.map(item => `<li>${item.name}</li>`).join('');

                card.innerHTML = `
                    <div class="ticket-header">
                        <span class="table-num">Table ${order.table_number}</span>
                        <span class="time-ago">${new Date(order.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <ul class="ticket-items">
                        ${itemsHtml}
                    </ul>
                    <div class="ticket-actions">
                        ${actionBtn}
                    </div>
                `;
                container.appendChild(card);
            });
        } catch (err) {
            console.error(err);
        }
    }

    async function updateStatus(orderId, newStatus) {
        try {
            const res = await fetch(`${API_BASE}dining-orders/${orderId}/update_status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ status: newStatus })
            });
            if(res.ok) {
                fetchOrders(); // Refresh
            } else {
                alert('Failed to update status');
            }
        } catch(err) {
            console.error(err);
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<style>
    .orders-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        padding: 20px;
    }
    .order-ticket {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .order-ticket.ordered { border-left: 5px solid #f1c40f; }
    .order-ticket.preparing { border-left: 5px solid #3498db; }
    
    .ticket-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
    .table-num { font-size: 1.2em; color: #333; }
    .ticket-items { list-style: none; padding: 0; margin-bottom: 15px; }
    .ticket-items li { padding: 5px 0; border-bottom: 1px dashed #eee; font-size: 1.1em; }
    .ticket-actions { text-align: center; }
</style>
{% endblock %}
