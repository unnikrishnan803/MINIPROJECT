{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Panel | Deliciae</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dashboard-body">

    <div class="glow-bg top-left" style="opacity: 0.5;"></div>
    <div class="glow-bg bottom-right" style="opacity: 0.5;"></div>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar glass-card">
            <div class="logo">
                <i class="fas fa-utensils"></i> Deliciae <span style="font-size: 0.6rem; background: var(--accent-primary); padding: 2px 5px; border-radius: 4px; margin-left: 5px;">Partner</span>
            </div>
            
            <nav class="side-nav">
                <a href="#" onclick="showSection('overview')" class="nav-item active"><i class="fas fa-home"></i> Overview</a>
                <a href="/dashboard/?view=tables" class="nav-item"><i class="fas fa-th-large"></i> Manage Tables</a>
                <a href="/kitchen-view/" class="nav-item"><i class="fas fa-fire"></i> Kitchen View</a>
                <a href="#" onclick="showSection('orders')" class="nav-item"><i class="fas fa-clipboard-list"></i> Orders</a>
                <a href="#" onclick="showSection('offers')" class="nav-item"><i class="fas fa-tags"></i> Offers</a>
                <a href="/restaurant/videos/" class="nav-item" onclick="event.stopPropagation();"><i class="fas fa-video"></i> My Posts</a>
                <a href="#" onclick="showSection('analytics')" class="nav-item"><i class="fas fa-chart-line"></i> Analytics</a>
                <a href="#" onclick="showSection('settings')" class="nav-item"><i class="fas fa-cog"></i> Settings</a>
            </nav>

            <div class="user-profile">
                <img src="{{ user.get_profile_picture }}" alt="Restaurant" class="avatar">
                <div class="user-info">
                    <h4>{{ user.restaurant_profile.name|default:user.username }}</h4>
                    <p>{{ user.restaurant_profile.cuisine_type|default:'Cuisine' }} ‚Ä¢ {{ user.restaurant_profile.rating|default:'N/A' }} ‚≠ê</p>
                </div>
                <a href="{% url 'account_logout' %}" class="logout-btn"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="dashboard-header">
                <div class="header-text">
                    <h1>Dashboard</h1>
                    <p>Overview of your restaurant's performance.</p>
                </div>
                <button class="btn btn-primary" onclick="openAddFoodModal()"><i class="fas fa-plus"></i> Add New Item</button>
                <button class="btn btn-secondary" onclick="document.getElementById('addReelModal').style.display='block'"><i class="fas fa-video"></i> Add Reel</button>
            </header>

            <!-- Overview Section -->
            <div id="overview-section">
                <!-- Stats Grid -->
                <section class="stats-grid">
                    <div class="glass-card stat-card">
                        <div class="stat-icon" style="background: rgba(76, 209, 55, 0.1); color: #4cd137;">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="stat-info">
                            <h3>{{ total_orders|default:0 }}</h3>
                            <p>Total Orders</p>
                        </div>
                    </div>

                    <div class="glass-card stat-card">
                        <div class="stat-icon" style="background: rgba(255, 107, 53, 0.1); color: var(--accent-primary);">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-info">
                            <h3>{{ trending_count|default:0 }} Items</h3>
                            <p>Trending Now</p>
                        </div>
                    </div>

                    <div class="glass-card stat-card">
                        <div class="stat-icon" style="background: rgba(64, 112, 244, 0.1); color: #4070f4;">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3>${{ revenue|default:0 }}</h3>
                            <p>Revenue (Total)</p>
                        </div>
                    </div>

                    <div class="glass-card stat-card">
                        <div class="stat-icon" style="background: rgba(155, 89, 182, 0.1); color: #9b59b6;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="crowdLevelDisplay">--</h3>
                            <p>Crowd Level <button class="btn btn-sm btn-icon" onclick="updateCrowdStatus()" title="Update Status"><i class="fas fa-sync-alt"></i></button></p>
                        </div>
                    </div>
                </section>




                <!-- Menu Management -->
                <section class="menu-section">
                    <h3>Live Menu Availability</h3>
                    <div class="menu-list glass-card">
                        <table class="menu-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Availability</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="menu-table-body">
                                <!-- Dynamic Content -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- Orders Section -->
            <div id="orders-section" style="display:none;">
                <h3>Active Orders</h3>
                <div id="restaurant-orders-grid" class="orders-grid">
                    <div class="loading">Loading active orders...</div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics-section" style="display:none;">
                <div class="glass-card" style="padding: 20px;">
                    <h3>Order Statistics</h3>
                    <div style="height: 400px;">
                        <canvas id="ordersChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Offers Section -->
            <div id="offers-section" style="display:none;">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Your Active Offers</h3>
                    <button class="btn btn-primary" onclick="openAddOfferModal()">+ Create Offer</button>
                </div>
                <div id="offers-list" class="grid-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <div style="text-align: center; color: white;">Loading offers...</div>
                </div>
            </div>

            <!-- Settings Section -->
            <!-- Settings Section -->
            <div id="settings-section" style="display:none;">
                <h2 style="margin-bottom: 20px;">Restaurant Profile Settings</h2>
                <div class="glass-card" style="padding: 30px; max-width: 800px;">
                    <form id="profileSettingsForm" onsubmit="updateProfile(event)">
                        
                        <div style="display: flex; gap: 30px; margin-bottom: 30px; align-items: start; flex-wrap: wrap;">
                            <div style="text-align: center;">
                                <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; margin-bottom: 10px; border: 3px solid var(--accent-primary); position: relative;">
                                    <img id="profilePreview" src="{{ user.get_profile_picture }}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <label for="profileImageInput" class="btn btn-sm btn-secondary" style="cursor: pointer;">
                                    <i class="fas fa-camera"></i> Change
                                </label>
                                <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="previewImage(this)">
                            </div>
                            
                            <div style="flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; min-width: 300px;">
                                <div class="form-group" style="grid-column: span 2;">
                                    <label>Restaurant Name</label>
                                    <input type="text" id="settingsName" class="form-input" value="{{ user.restaurant_profile.name }}">
                                </div>
                                
                                <div class="form-group">
                                    <label>Cuisine Type</label>
                                    <input type="text" id="settingsCuisine" class="form-input" value="{{ user.restaurant_profile.cuisine_type }}">
                                </div>
                                
                                <div class="form-group" style="grid-column: span 2;">
                                    <label>Location</label>
                                    <input type="text" id="settingsLocation" class="form-input" value="{{ user.restaurant_profile.location }}">
                                </div>

                                <div class="form-group" style="grid-column: span 2;">
                                    <label>Google Maps Link <small style="color: rgba(255,255,255,0.5); font-weight: normal;">(Auto-extracts coordinates)</small></label>
                                    <input type="text" id="settingsMapsLink" class="form-input" placeholder="Paste Google Maps link here to update coordinates">
                                </div>
                                
                                <div class="form-group">
                                    <label>Opening Time</label>
                                    <input type="time" id="settingsOpenTime" class="form-input" value="{{ user.restaurant_profile.opening_time|time:'H:i' }}">
                                </div>
                                
                                <div class="form-group">
                                    <label>Closing Time</label>
                                    <input type="time" id="settingsCloseTime" class="form-input" value="{{ user.restaurant_profile.closing_time|time:'H:i' }}">
                                </div>
                                
                                <div class="form-group" style="grid-column: span 2;">
                                     <label class="switch">
                                        <input type="checkbox" id="settingsIsOpen" {{ user.restaurant_profile.is_open|yesno:"checked," }}>
                                        <span class="slider round"></span>
                                        <span style="margin-left: 10px; color: white;">Open for Business</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: flex-end; gap: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal (Add Food) -->
    <div id="addFoodModal" class="modal">
        <div class="modal-content glass-card">
            <span class="close-modal" onclick="closeAddFoodModal()">&times;</span>
            <h2>Add New Item</h2>
            <form>
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="newItemName" class="form-input" placeholder="e.g. Seafood Pasta">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="newItemCategory" class="form-input" style="background: rgba(255,255,255,0.05); color: white;">
                        <option>Italian</option>
                        <option>Indian</option>
                        <option>Mexican</option>
                        <option>Chinese</option>
                        <option>Desserts</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Price ($)</label>
                    <input type="number" id="newItemPrice" class="form-input" placeholder="10.00">
                </div>
                <div class="form-group">
                    <label>Dish Image</label>
                    <input type="file" id="newItemImage" class="form-input" accept="image/*">
                    <small style="color: rgba(255,255,255,0.5); font-size: 0.7rem;">Upload a photo of your dish (JPG, PNG)</small>
                </div>
                <button type="button" class="btn btn-primary btn-full" onclick="addFoodItem()">Add Item</button>
            </form>
        </div>
    </div>

    <!-- Modal (Add Offer) -->
    <div id="addOfferModal" class="modal">
        <div class="modal-content glass-card">
            <span class="close-modal" onclick="document.getElementById('addOfferModal').style.display='none'">&times;</span>
            <h2>Create Special Offer üéâ</h2>
            <form onsubmit="event.preventDefault(); createOffer();">
                <div class="form-group">
                    <label>Offer Title</label>
                    <input type="text" id="offerTitle" class="form-input" placeholder="e.g. 50% Off Pasta" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="offerDesc" class="form-input" placeholder="Terms and conditions..." rows="2"></textarea>
                </div>
                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Discount %</label>
                        <input type="number" id="offerDiscount" class="form-input" placeholder="20" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label>Valid Until</label>
                        <input type="datetime-local" id="offerEndDate" class="form-input" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Launch Offer üöÄ</button>
            </form>
        </div>
    </div>

    <!-- Modal (Add Reel) -->
    <div id="addReelModal" class="modal">
        <div class="modal-content glass-card">
            <span class="close-modal" onclick="document.getElementById('addReelModal').style.display='none'">&times;</span>
            <h2>Upload New Reel üé•</h2>
            <form onsubmit="event.preventDefault(); uploadReel();">
                <div class="form-group">
                    <label>Video File</label>
                    <input type="file" id="reelVideoFile" class="form-input" accept="video/*" required>
                    <small style="color: rgba(255,255,255,0.5);">Upload MP4 or WebM video file</small>
                </div>
                <div class="form-group">
                    <label>Caption</label>
                    <textarea id="reelCaption" class="form-input" placeholder="Describe this delicious moment..." rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Post Reel</button>
            </form>
        </div>
    </div>

    <script>
        let ordersChart = null;

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function addFoodItem() {
            const name = document.getElementById('newItemName').value;
            const category = document.getElementById('newItemCategory').value;
            const price = document.getElementById('newItemPrice').value;
            const imageFile = document.getElementById('newItemImage').files[0];

            // Validation
            if(!name || !price) {
                alert("Please fill in Name and Price");
                return;
            }

            // Image file validation
            if(imageFile) {
                const validImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                if(!validImageTypes.includes(imageFile.type)) {
                    alert('Please upload a valid image file (JPG, PNG, or WebP)');
                    return;
                }
                // Max 5MB
                if(imageFile.size > 5 * 1024 * 1024) {
                    alert('Image size must be less than 5MB');
                    return;
                }
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('category', category);
            formData.append('price', price);
            formData.append('is_available', true);
            
            if(imageFile) {
                formData.append('image', imageFile);
            }

            try {
                const res = await fetch('/api/food-items/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                });

                if(res.ok) {
                    alert('‚úÖ Item added successfully!');
                    closeAddFoodModal();
                    fetchMenuItems(); // Refresh list
                    // Clear form
                    document.querySelector('#addFoodModal form').reset();
                } else {
                    const contentType = res.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const data = await res.json();
                        const errorMsg = Object.entries(data).map(([key, val]) => `${key}: ${val}`).join('\n');
                        alert('‚ùå Error adding item:\n' + errorMsg);
                    } else {
                        alert('‚ùå Server error. Status: ' + res.status);
                    }
                }
            } catch(err) {
                console.error(err);
                alert('Failed to connect to server.');
            }
        }

        // Modal Functions
        let currentEditingId = null;

        function openAddFoodModal() {
            currentEditingId = null;
            const modal = document.getElementById('addFoodModal');
            if (modal) {
                modal.style.display = 'block';
                document.querySelector('#addFoodModal h2').innerText = "Add New Item";
                document.querySelector('#addFoodModal .btn-primary').innerText = "Add Item";
                document.querySelector('#addFoodModal .btn-primary').onclick = addFoodItem;
                document.querySelector('#addFoodModal form').reset();
            }
        }

        async function openEditFoodModal(id) {
            currentEditingId = id;
            const modal = document.getElementById('addFoodModal');
            if (modal) {
                modal.style.display = 'block';
                document.querySelector('#addFoodModal h2').innerText = "Edit Item";
                document.querySelector('#addFoodModal .btn-primary').innerText = "Save Changes";
                document.querySelector('#addFoodModal .btn-primary').onclick = function() { updateFoodItem(id); };
                
                // Clear any previous file selection
                document.getElementById('newItemImage').value = '';

                // Fetch item details to populate form
                try {
                    const res = await fetch(`/api/food-items/${id}/`);
                    if(res.ok) {
                        const item = await res.json();
                        document.getElementById('newItemName').value = item.name;
                        document.getElementById('newItemCategory').value = item.category;
                        document.getElementById('newItemPrice').value = item.price;
                    }
                } catch(e) {
                    console.error("Error fetching item details", e);
                }
            }
        }

        async function updateFoodItem(id) {
            const name = document.getElementById('newItemName').value;
            const category = document.getElementById('newItemCategory').value;
            const price = document.getElementById('newItemPrice').value;
            const imageFile = document.getElementById('newItemImage').files[0];

            // Validation logic (copied from addFoodItem)
            if(imageFile) {
                const validImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                if(!validImageTypes.includes(imageFile.type)) {
                    alert('Please upload a valid image file (JPG, PNG, or WebP)');
                    return;
                }
                // Max 5MB
                if(imageFile.size > 5 * 1024 * 1024) {
                    alert('Image size must be less than 5MB');
                    return;
                }
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('category', category);
            formData.append('price', price);
            if(imageFile) {
                formData.append('image', imageFile);
            }

            try {
                const res = await fetch(`/api/food-items/${id}/`, {
                    method: 'PATCH',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    body: formData
                });

                if(res.ok) {
                    alert('Item updated successfully!');
                    closeAddFoodModal();
                    fetchMenuItems();
                } else {
                    const data = await res.json();
                    alert('Error updating item: ' + JSON.stringify(data));
                }
            } catch(err) {
                console.error(err);
                alert('Failed to connect to server.');
            }
        }

        async function deleteFoodItem(id) {
            if(!confirm("Are you sure you want to delete this item?")) return;

            try {
                const res = await fetch(`/api/food-items/${id}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                });

                if(res.ok) {
                    fetchMenuItems(); // Refresh list
                } else {
                    alert('Error deleting item');
                }
            } catch(err) {
                console.error(err);
                alert('Failed to delete item.');
            }
        }

        function closeAddFoodModal() {
            const modal = document.getElementById('addFoodModal');
            if (modal) modal.style.display = 'none';
        }

        // Close modal if clicked outside
        window.onclick = function(event) {
            const modal = document.getElementById('addFoodModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
    <script>
        // Navigation Logic
        function showSection(sectionId) {
            // Hide all sections
            document.getElementById('overview-section').style.display = 'none';
            document.getElementById('orders-section').style.display = 'none';
            document.getElementById('analytics-section').style.display = 'none';
            document.getElementById('settings-section').style.display = 'none';
            document.getElementById('offers-section').style.display = 'none';

            // Update Nav Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Show selected section
            if(sectionId === 'overview') {
                document.getElementById('overview-section').style.display = 'block';
                const link = document.querySelector("a[onclick=\"showSection('overview')\"]");
                if(link) link.classList.add('active');
            } else if(sectionId === 'orders') {
                document.getElementById('orders-section').style.display = 'block';
                const link = document.querySelector("a[onclick=\"showSection('orders')\"]");
                if(link) link.classList.add('active');
                fetchRestaurantOrders(); 
            } else if (sectionId === 'offers') {
                document.getElementById('offers-section').style.display = 'block';
                const link = document.querySelector("a[onclick=\"showSection('offers')\"]");
                if(link) link.classList.add('active');
                fetchRestaurantOffers();
            } else if (sectionId === 'analytics') {
                document.getElementById('analytics-section').style.display = 'block';
                const link = document.querySelector("a[onclick=\"showSection('analytics')\"]");
                if(link) link.classList.add('active');
                fetchAnalytics();
            } else if (sectionId === 'settings') {
                document.getElementById('settings-section').style.display = 'block';
                const link = document.querySelector("a[onclick=\"showSection('settings')\"]");
                if(link) link.classList.add('active');
            }
        }

        // Fetch Menu Items Logic
        async function fetchMenuItems() {
            const tbody = document.getElementById('menu-table-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading menu...</td></tr>';
            
            try {
                const res = await fetch('/api/food-items/');
                const data = await res.json();
                const items = data.results ? data.results : data;
                
                tbody.innerHTML = '';
                
                if(!items || items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No items found. Add your first dish!</td></tr>';
                    return;
                }
                
                items.forEach(item => {
                    const tr = document.createElement('tr');
                    // Prioritize uploaded image over image_url
                    const imageUrl = item.image || item.image_url || 'https://via.placeholder.com/100';
                    tr.innerHTML = `
                        <td>
                            <div class="item-cell">
                                <img src="${imageUrl}" alt="Img" onerror="this.src='https://via.placeholder.com/100'">
                                <span>${item.name}</span>
                            </div>
                        </td>
                        <td>${item.category}</td>
                        <td>$${item.price}</td>
                        <td>${item.trend_score > 5 ? '<span class="badge trending"><i class="fas fa-fire"></i> Trending</span>' : '<span class="text-muted">-</span>'}</td>
                        <td>
                            <label class="switch">
                                <input type="checkbox" ${item.is_available ? 'checked' : ''} onchange="toggleItemAvailability(${item.id}, this)">
                                <span class="slider round"></span>
                            </label>
                        </td>
                        <td>
                            <button class="btn-icon" onclick="openEditFoodModal(${item.id})" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon delete-btn" onclick="deleteFoodItem(${item.id})" title="Delete" style="color: #ff6b6b;"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch(err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Error loading menu.</td></tr>';
            }
        }

        async function toggleItemAvailability(id, checkbox) {
             try {
                const res = await fetch(`/food/${id}/toggle/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                });
                if(!res.ok) throw new Error('Failed');
             } catch(err) {
                 alert('Error updating availability');
                 checkbox.checked = !checkbox.checked; // Revert
             }
        }
        
        // Helper for CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            showSection('overview');
            fetchMenuItems(); // Fetch menu on load
            updateCrowdStatus(); // Fetch crowd status
        });

        async function updateCrowdStatus() {
            try {
                const res = await fetch('/crowd/update/', { 
                    method: 'POST', 
                    headers: {'X-CSRFToken': getCookie('csrftoken')} 
                });
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('crowdLevelDisplay').innerText = data.crowd_level || 'Low';
                }
            } catch(e) { console.error("Crowd Update Error", e); }
        }
        async function fetchRestaurantOrders() {
            const container = document.getElementById('restaurant-orders-grid');
            if(!container) return;
            container.innerHTML = '<div class="loader">Loading...</div>';
            
            try {
                // Fetch orders that are Ordered, Preparing, or Served (excluding Paid/Completed for now unless requested)
                const res = await fetch(`/api/dining-orders/?status=Ordered,Preparing,Served&t=${new Date().getTime()}`);
                const data = await res.json();
                const orders = data.results ? data.results : data;
                
                container.innerHTML = '';
                if(!orders || orders.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No active orders right now.</div>';
                    return;
                }

                orders.forEach(order => {
                    const card = document.createElement('div');
                    card.className = `order-card ${order.status.toLowerCase()}`;
                    
                    let itemsHtml = order.items_details.map(item => `<li>${item.name} <span style="float:right;">$${item.price}</span></li>`).join('');
                    
                    // Fallback for missing table
                    let tableDisplay = '';
                    if (order.table_number) {
                        tableDisplay = `Table ${order.table_number}`;
                    } else {
                        // Capitalize order type
                         tableDisplay = (order.order_type || 'Order').charAt(0).toUpperCase() + (order.order_type || 'Order').slice(1);
                    }

                    card.innerHTML = `
                        <div class="order-header">
                            <span class="table-tag">${tableDisplay}</span>
                            <span class="status-tag ${order.status.toLowerCase()}">${order.status}</span>
                        </div>
                        <ul class="order-items">
                            ${itemsHtml}
                        </ul>
                        <div class="order-total">Total: ${order.total_amount}</div>
                        <div class="time-ago">üïí ${new Date(order.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    `;
                    container.appendChild(card);
                });
            } catch(err) {
                console.error(err);
                container.innerHTML = '<p style="color:red; text-align:center;">Error loading orders.</p>';
            }
        }
        

        async function fetchAnalytics() {
            try {
                // Fetch all orders to calculate stats locally for now
                const res = await fetch('/api/dining-orders/');
                const data = await res.json();
                const orders = data.results || data;

                // Group by Status
                const stats = {
                    'Ordered': 0,
                    'Preparing': 0,
                    'Served': 0,
                    'Paid': 0
                };

                orders.forEach(o => {
                    if(stats[o.status] !== undefined) stats[o.status]++;
                });

                const ctx = document.getElementById('ordersChart').getContext('2d');
                
                if(ordersChart) ordersChart.destroy();

                ordersChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(stats),
                        datasets: [{
                            label: '# of Orders',
                            data: Object.values(stats),
                            backgroundColor: [
                                'rgba(255, 206, 86, 0.6)', // Ordered (Yellow)
                                'rgba(54, 162, 235, 0.6)', // Preparing (Blue)
                                'rgba(75, 192, 192, 0.6)', // Served (Green)
                                'rgba(153, 102, 255, 0.6)' // Paid (Purple)
                            ],
                            borderColor: [
                                'rgba(255, 206, 86, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: 'white' }
                            },
                            x: {
                                ticks: { color: 'white' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: 'white' } }
                        }
                    }
                });

            } catch(err) {
                console.error("Analytics Error", err);
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePreview').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function updateProfile(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Saving...';
            btn.disabled = true;

            const formData = new FormData();
            formData.append('name', document.getElementById('settingsName').value);
            formData.append('cuisine_type', document.getElementById('settingsCuisine').value);
            formData.append('location', document.getElementById('settingsLocation').value);
            formData.append('is_open', document.getElementById('settingsIsOpen').checked);
            
            const mapsLink = document.getElementById('settingsMapsLink').value;
            if(mapsLink) {
                formData.append('maps_link', mapsLink);
            }
            
            const openTime = document.getElementById('settingsOpenTime').value;
            const closeTime = document.getElementById('settingsCloseTime').value;
            if(openTime) formData.append('opening_time', openTime);
            if(closeTime) formData.append('closing_time', closeTime);

            const imageInput = document.getElementById('profileImageInput');
            if(imageInput.files[0]) {
                formData.append('image', imageInput.files[0]);
            }

            try {
                const res = await fetch('/api/restaurant/profile/', {
                    method: 'PATCH',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    body: formData
                });

                if(res.ok) {
                    alert('Profile Updated Successfully!');
                    location.reload(); 
                } else {
                    const contentType = res.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const err = await res.json();
                        alert('Error: ' + JSON.stringify(err));
                    } else {
                        const text = await res.text();
                        console.error("Server Error:", text);
                        alert('Server Error (Check Console for details). Status: ' + res.status);
                    }
                }
            } catch(error) {
                console.error("Fetch error:", error);
                alert('Connection Failed: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function uploadReel() {
            const videoFile = document.getElementById('reelVideoFile').files[0];
            const caption = document.getElementById('reelCaption').value;
            
            // Validation
            if(!videoFile) {
                alert("üìπ Please select a video file");
                return;
            }

            // Video file type validation
            const validVideoTypes = ['video/mp4', 'video/webm', 'video/quicktime', 'video/x-matroska'];
            if(!validVideoTypes.includes(videoFile.type)) {
                alert('‚ùå Please upload a valid video file (MP4, WebM, MOV, or MKV)');
                return;
            }

            // Max 50MB for videos
            const maxSize = 50 * 1024 * 1024;
            if(videoFile.size > maxSize) {
                alert('‚ùå Video size must be less than 50MB.\nCurrent size: ' + (videoFile.size / (1024 * 1024)).toFixed(2) + 'MB');
                return;
            }

            const btn = document.querySelector('#addReelModal button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            btn.disabled = true;

            const formData = new FormData();
            formData.append('video_file', videoFile);
            formData.append('caption', caption);

            try {
                // Fixed: Point to the upload endpoint
                const res = await fetch('/api/reels/upload/', {
                     method: 'POST',
                     headers: { 
                        'X-CSRFToken': getCookie('csrftoken')
                     },
                     body: formData
                });
                
                if(res.ok) {
                    alert("‚úÖ Reel Posted Successfully! üé•\nYour reel will appear in the feed shortly.");
                    document.getElementById('addReelModal').style.display = 'none';
                    document.getElementById('reelVideoFile').value = '';
                    document.getElementById('reelCaption').value = '';
                } else {
                    const contentType = res.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const err = await res.json();
                        const errorMsg = err.error || JSON.stringify(err);
                        alert("‚ùå Error posting reel: " + errorMsg);
                    } else {
                        alert("‚ùå Server error. Status: " + res.status + "\nPlease try again or contact support.");
                    }
                }
            } catch(e) {
                console.error(e);
                alert("Failed to connect to server.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- Offers Logic ---
        function openAddOfferModal() {
            document.getElementById('addOfferModal').style.display = 'block';
        }

        async function fetchRestaurantOffers() {
            const container = document.getElementById('offers-list');
            container.innerHTML = '<div style="text-align:center; color:white;">Loading offers...</div>';
            
            try {
                const res = await fetch('/api/offers/');
                const data = await res.json();
                const offers = data.results || data;
                
                container.innerHTML = '';
                
                if(!offers || offers.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding: 40px; color: rgba(255,255,255,0.6); grid-column: 1/-1;">No active offers. Create one to boost sales! üöÄ</div>';
                    return;
                }
                
                offers.forEach(offer => {
                    const card = document.createElement('div');
                    card.className = 'glass-card';
                    card.style.padding = '20px';
                    card.style.position = 'relative';
                    
                    const endDate = new Date(offer.valid_until).toLocaleDateString();
                    const isActive = new Date(offer.valid_until) > new Date();
                    const statusBadge = isActive 
                        ? '<span style="background: #4cd137; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">Active</span>' 
                        : '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">Expired</span>';
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <h3 style="margin: 0; color: var(--accent-primary);">${offer.discount_percentage}% OFF</h3>
                            ${statusBadge}
                        </div>
                        <h4 style="margin: 10px 0 5px;">${offer.title}</h4>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;">${offer.description}</p>
                        <div style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 15px;">
                            <i class="fas fa-clock"></i> Valid until: ${endDate}
                        </div>
                        <button onclick="deleteOffer(${offer.id})" class="btn btn-sm" style="background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; width: 100%;">
                            <i class="fas fa-trash"></i> Delete Offer
                        </button>
                    `;
                    container.appendChild(card);
                });
                
            } catch(err) {
                console.error(err);
                container.innerHTML = '<div style="color: #e74c3c; text-align: center;">Failed to load offers.</div>';
            }
        }

        async function createOffer() {
            const btn = document.querySelector('#addOfferModal button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Creating...';
            btn.disabled = true;
            
            const payload = {
                title: document.getElementById('offerTitle').value,
                description: document.getElementById('offerDesc').value,
                discount_percentage: document.getElementById('offerDiscount').value,
                valid_until: document.getElementById('offerEndDate').value,
                is_active: true
            };
            
            try {
                const res = await fetch('/api/offers/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify(payload)
                });
                
                if(res.ok) {
                    alert('Offer Created Successfully! üéâ');
                    document.getElementById('addOfferModal').style.display = 'none';
                    document.getElementById('addOfferModal').querySelector('form').reset();
                    fetchRestaurantOffers();
                } else {
                    const err = await res.json();
                    alert('Error: ' + JSON.stringify(err));
                }
            } catch(e) {
                console.error(e);
                alert('Connection Failed');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function deleteOffer(id) {
            if(!confirm('Are you sure you want to delete this offer?')) return;
            
            try {
                const res = await fetch(`/api/offers/${id}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                });
                if(res.ok) {
                    fetchRestaurantOffers();
                } else {
                    alert('Failed to delete offer');
                }
            } catch(e) {
                console.error(e);
                alert('Connection error');
            }
        }
        

        
    </script>
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
    <style>
        /* Order Card Styles (Same as Staff Dashboard) */
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .order-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 5px solid #ddd;
            color: #333; /* Force dark text */
        }
        .order-card.ordered { border-left-color: #f1c40f; }
        .order-card.preparing { border-left-color: #3498db; }
        .order-card.served { border-left-color: #2ecc71; }
        
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .table-tag { font-weight: bold; font-size: 1.1em; }
        .status-tag { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8em; }
        .status-tag.ordered { background: #f1c40f; color: #333; }
        .status-tag.preparing { background: #3498db; }
        .status-tag.served { background: #2ecc71; }
        
        .order-items { list-style: none; padding: 0; margin: 10px 0; border-top: 1px dashed #eee; border-bottom: 1px dashed #eee; padding: 10px 0; }
        .order-items li { padding: 2px 0; }
        .order-total { font-weight: bold; text-align: right; margin-top: 5px; }
    </style>
    

    
</body>
</html>
